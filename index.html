
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="">
  <meta name="author" content="">

  <title>O3 Dapp Platform</title>

  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
  <script type="text/javascript" src="./source/o3-0.0.1.js"></script>
  <!-- <script src="https://ajax.aspnetcdn.com/ajax/jQuery/jquery-3.3.1.min.js"></script> -->
</head>

<body>

  <nav class="navbar navbar-expand-md navbar-dark bg-dark mb-4">
    <a class="navbar-brand" href="#">O3 Dapp Platform</a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarCollapse">

    </div>
  </nav>
  <div class="container">
   <h3>Available functions</h3>

   <div class="row">
    <div class="col-8">

      <div class="row">
        <div class="col-12 mb-4">
         <div class="card" >
           <div class="card-body">
             <h5 class="card-title">转账测试</h5>
             <p class="card-text">
               from:<code id="addrFrom"></code>
               <br />
               publicKey:<code id="pk"></code>
               <br />
               to:<code id="addrTo">AeaWf2v7MHGpzxH4TtBAu5kJRp5mRq2DQG</code>
               <br />
               txHex:<code id="txHex"></code>
               <br />
               sign:<code id="sign"></code>
               <br />
               TXID:<code id="TXID"></code>
               <p>使用 O3 API 转账 0.01GAS 到上面地址</p>
             </p>
             <button type="button" class="btn btn-primary" onclick="TransferTest()">测试转账</button>
             <div id="callback2"></div>
             <div id="error2"></div>
           </div>
         </div>
       </div>

     <div class="row">
       <div class="col-12 mb-4">
        <div class="card" >
          <div class="card-body">
            <h5 class="card-title">Init</h5>
            <p class="card-text">
              <code>o3.init(callbackFunction)</code>
              <p>Use this function to initialize o3 by passing a callback function that you would like to receive a response from O3 App</p>
            </p>
            <button type="button" class="btn btn-primary" onclick="o3Init()">O3 Init</button>
          </div>
        </div>
      </div> <!-- col -->

      <div class="col-12 mb-4">
        <div class="card" >
          <div class="card-body">
            <h5 class="card-title">Request to connect</h5>
            <p class="card-text">
              <code>o3.requestToConnect()</code>
              <p>Use this function to request a permission from a user that your dapp would like to connect.</p>
            </p>
            <button type="button" class="btn btn-primary" onclick="requestToConnect()">Request to Connect</button>
          </div>
        </div>
      </div> <!-- col -->

      <div class="col-12 mb-4">
        <div class="card" >
          <div class="card-body">
            <h5 class="card-title">Get current platform</h5>
            <p class="card-text">
              <code>o3.getPlatform()</code>
              <p>Use this function to get a user's device platform</p>
            </p>
            <button type="button" class="btn btn-primary" onclick="getPlatform()">Get platform</button>
          </div>
        </div>
      </div> <!-- col -->

      <div class="col-12 mb-4">
        <div class="card" >
          <div class="card-body">
            <h5 class="card-title">Get accounts</h5>
            <p class="card-text">
              <code>o3.getAccounts()</code>
              <p>Use this function to get logged in accounts. Response includes address and public key.</p>
            </p>
            <button type="button" class="btn btn-primary" onclick="getAccounts()">Get accounts</button>
          </div>
        </div>
      </div> <!-- col -->

      <div class="col-12 mb-4">
        <div class="card" >
          <div class="card-body">
            <h5 class="card-title">Check app status</h5>
            <p class="card-text">
              <code>o3.isAppAvailable()</code>
              <p>Use this function to check if users is still logged in to O3. If browser is closed, response will be false.</p>
            </p>
            <button type="button" class="btn btn-primary" onclick="isAppAvailable()">IsO3Available</button>
          </div>
        </div>
      </div> <!-- col -->


      <div class="col-12 mb-4">
        <div class="card" >
          <div class="card-body">
            <h5 class="card-title">Get device info</h5>
            <p class="card-text">
              <code>o3.getDeviceInfo()</code>
              <p>Use this function to get user's device information.</p>
            </p>
            <button type="button" class="btn btn-primary" onclick="getDeviceInfo()">Get Device Info</button>
          </div>
        </div>
      </div> <!-- col -->


      <div class="col-12 mb-4">
        <div class="card" >
          <div class="card-body">
            <h5 class="card-title">Sign transaction</h5>
            <p class="card-text">
              <code>o3.requestToSignRawTransaction(rawTxInHex)</code>
              <p>Use this function to request a user to sign a raw transaction. Response is signed transaction with user's private key.</p>
            </p>
            <button type="button" class="btn btn-primary" onclick="requestToSignRawTransaction()">Sign </button>
          </div>
        </div>
      </div> <!-- col -->



    </div> <!-- row -->

  </div>
  <div class="col">
    <p>Output</p>

    
  <div id="callback"></div>
  <div id="error"></div>
  </div>
</div>



</div> <!-- container -->

<script type="text/javascript">
//初始化
o3Init();

function makeRpcPostBody(method, ..._params)
{
    var body = {};
    body["jsonrpc"] = "2.0";
    body["id"] = 1;
    body["method"] = method;
    var params = [];
    for (var i = 0; i < _params.length; i++)
    {
        params.push(_params[i]);
    }
    body["params"] = params;
    return body;
}

function gettransfertxhex (from,to,assetID,amount)
{
  var api = "https://api.nel.group/api/testnet";
  var postdata = makeRpcPostBody("gettransfertxhex", from,to,assetID,amount);
  var result = fetch(api, { "method": "post", "body": JSON.stringify(postdata) })        
                .then(result=>{
                  result.json()
                    .then(r=>{
                        console.log(r);
                        document.getElementById("txHex").innerText = r.result[0].transfertxhex;
                        requestToSignRawTransaction(r.result[0].transfertxhex);
                    })
                  })  
}

function sendtxplussign (txHex, sign, pk)
{
  var api = "https://api.nel.group/api/testnet";
  var postdata = makeRpcPostBody("sendtxplussign", txHex, sign, pk);
  // document.getElementById("TXID").innerText = JSON.stringify(postdata);
  var result = fetch(api, { "method": "post", "body": JSON.stringify(postdata) })        
                .then(result=>{
                  result.json()
                    .then(r=>{
                        console.log(r);
                        document.getElementById("TXID").innerText = JSON.stringify(r);
                    })
                  })  
}

  function callbackHandler(response) {
   if (response == null) {
    document.getElementById("error").innerHTML = "You don't have o3 app installed";
  } else {
    document.getElementById("callback").innerText +=JSON.stringify(response);  
  }
};

  function callbackHandler2(response) {
   if (response == null) {
    document.getElementById("error").innerHTML = "需要在O3钱包中操作";
  } else {
    document.getElementById("callback").innerText +=JSON.stringify(response);

    if(response.command == "init"){
      requestToConnect();
    }
    else if(response.command == "requestToConnect"){
      getAccounts();
    }
    else if(response.command == "getAccounts"){
      document.getElementById("addrFrom").innerText = response.data.accounts[0].neo.address;
      document.getElementById("pk").innerText = response.data.accounts[0].neo.publicKey;
    }
    else if(response.command == "requestToSign"){
      document.getElementById("sign").innerText = response.data.signatureData;
      sendtxplussign(document.getElementById("txHex").innerText,response.data.signatureData,document.getElementById("pk").innerText)
    }
  }
};


function getPlatform(){
  o3.getPlatform();
}

function getAccounts(){
  o3.getAccounts()
}

function requestToConnect(){
  o3.requestToConnect()
}

function isAppAvailable(){
  o3.isAppAvailable();
}

function requestToSignRawTransaction(raw){
  o3.requestToSignRawTransaction(raw);
}

function getDeviceInfo() {
  o3.getDeviceInfo()
}

function o3Init(){
  o3.init(callbackHandler2);
}

function TransferTest(){
  gettransfertxhex(document.getElementById("addrFrom").innerText,document.getElementById("addrTo").innerText,"0x602c79718b16e442de58778e148d0b1084e3b2dffd5de6b7b16cee7969282de7",0.01);
}

</script>


</body>
</html>
